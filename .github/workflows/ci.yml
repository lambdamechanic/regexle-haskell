name: CI

on:
  push:
    branches: [ "main", "regex-12-Z3-port" ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NIX_CONFIG: |
        experimental-features = nix-command flakes
        accept-flake-config = true
        extra-substituters = https://attic.app.lambdamechanic.com/lambdamechanic-main https://cache.nixos.org/
        extra-trusted-public-keys = lambdamechanic-main:5wNxMhT/4Jdev6LshHRyV7B3YTQZzfj+e8dyWDFyoNU= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
      ATTIC_TOKEN: ${{ secrets.ATTIC_TOKEN }}
      ATTIC_CACHE: lambdamechanic-main
      ATTIC_ENDPOINT: https://attic.app.lambdamechanic.com/
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Validate Attic secret
        run: |
          if [ -z "${ATTIC_TOKEN}" ]; then
            echo "ATTIC_TOKEN is required for cached builds" >&2
            exit 1
          fi

      - name: Configure Attic cache
        run: |
          nix run github:zhaofengli/attic#default -- login ci "${ATTIC_ENDPOINT}" "${ATTIC_TOKEN}"
          nix run github:zhaofengli/attic#default -- use "${ATTIC_CACHE}"

      - name: Determine nix system
        id: nix-system
        run: echo "system=$(nix eval --raw --impure --expr 'builtins.currentSystem')" >> "$GITHUB_OUTPUT"

      - name: Build & test (flake checks)
        run: nix build .#default .#checks.${{ steps.nix-system.outputs.system }}.tests

      - name: Push build artifacts to Attic
        if: github.event_name != 'pull_request'
        run: |
          nix run github:zhaofengli/attic#default -- login ci "${ATTIC_ENDPOINT}" "${ATTIC_TOKEN}"
          nix run github:zhaofengli/attic#default -- push "${ATTIC_CACHE}" "$(nix path-info .#default)" "$(nix path-info .#checks.${{ steps.nix-system.outputs.system }}.tests)"
